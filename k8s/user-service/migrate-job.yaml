apiVersion: batch/v1
kind: Job
metadata:
  name: user-service-migrate
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: migrate
        image: qummach/user-service:latest
        command: ["alembic", "upgrade", "head"]
        env:
        - name: POSTGRES_DB
          valueFrom:
            secretKeyRef:
              name: user-postgres-secret
              key: db-name
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: user-postgres-secret
              key: username
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: user-postgres-secret
              key: password
        - name: POSTGRES_HOST
          value: "user-postgres"
        - name: POSTGRES_PORT
          value: "5432"
        - name: REDIS_URL
          value: "redis://redis:6379/0"
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: redis-secret
              key: password
        - name: SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: user-service-secrets
              key: secret-key
        - name: API_GATEWAY_URL
          value: "http://api-gateway:8000"
        - name: FRONTEND_URL
          value: "http://frontend:3000"
        - name: SMTP_HOST
          valueFrom:
            configMapKeyRef:
              name: user-service-config
              key: smtp-host
        - name: SMTP_PORT
          value: "587"
        - name: SMTP_USERNAME
          valueFrom:
            secretKeyRef:
              name: user-service-secrets
              key: smtp-username
        - name: SMTP_PASSWORD
          valueFrom:
            secretKeyRef:
              name: user-service-secrets
              key: smtp-password
        - name: SMTP_FROM_EMAIL
          valueFrom:
            secretKeyRef:
              name: user-service-secrets
              key: smtp-from-email
      initContainers:
      - name: wait-for-postgres
        image: busybox
        command: ['sh', '-c', 'until nc -z user-postgres:5432; do echo waiting for postgres; sleep 2; done']